unit Model.Pessoas;

interface

uses FireDAC.Comp.Client,System.JSON , DataSet.Serialize,
     Data.DB, System.SysUtils, Model.Connection, GBSwagger.Model.Attributes;

type
    TPessoa = class
    private
        Fsequencia: Integer;
        Fnome: string;
        Frg: string;
        Fcpf: string;
        Fsexo: string;
        Fdatanascimento : string;
        Ffoto: string;
    public
        constructor Create;
        destructor Destroy; override;

        [SwagProp('sequencia', True)]
        property sequencia : Integer read Fsequencia write Fsequencia;

        [SwagProp('nome', True)]
        property nome : string read Fnome write Fnome;

        [SwagProp('rg', True)]
        property rg : string read Frg write Frg;

        [SwagProp('cpf', True)]
        property cpf : string read Fcpf write Fcpf;

        [SwagProp('sexo', True)]
        property sexo : string read Fsexo write Fsexo;

        [SwagProp('datanascimento', True)]
        property datanascimento : string read Fdatanascimento write Fdatanascimento;

        [SwagProp('foto', True)]
        property foto : string read Ffoto write Ffoto;

        function Editar(out erro: string): Boolean;
end;

implementation

{ TCliente }

constructor TPessoa.Create;
begin
    Model.Connection.Connect;
end;

destructor TPessoa.Destroy;
begin
    Model.Connection.Disconect;
end;


function TPessoa.Editar(out erro: string): Boolean;
var
    qry : TFDQuery;
begin
    // Valida
    if SEQUENCIA <= 0 then
    begin
        Result := false;
        erro := 'Informe a sequencia';
        exit;
    end;

    if (NOME + RG + CPF + SEXO + DATANASCIMENTO + FOTO) = '' then
    begin
        Result := false;
        erro := 'Requisição vazia';
        exit;
    end;

    try
        qry := TFDQuery.Create(nil);
        qry.Connection := Model.Connection.FConnection;

        with qry do
        begin
            Active := false;
            sql.Clear;
            SQL.Add('UPDATE PESSOAS SET ');


            if NOME <> '' then
            BEGIN
              SQL.Add(' NOME=:NOME, ');
              ParamByName('NOME').Value := NOME;
            END;

            if RG <> '' then
            BEGIN
              SQL.Add(' RG=:RG ,');
              ParamByName('RG').Value := RG;
            END;

            if CPF <> '' then
            BEGIN
              SQL.Add(' CPF=:CPF, ');
              ParamByName('CPF').Value := CPF;
            END;

            if SEXO <> '' then
            BEGIN
              SQL.Add(' SEXO=:SEXO, ');
              ParamByName('SEXO').Value := SEXO;
            END;

            if DATANASCIMENTO <> '' then
            BEGIN
              SQL.Add(' DATANASCIMENTO=:DATANASCIMENTO, ');
              ParamByName('DATANASCIMENTO').Value := DATANASCIMENTO;
            END;

            if FOTO <> '' then
            BEGIN
              SQL.Add(' FOTO=:FOTO, ');
              ParamByName('FOTO').Value := FOTO;
            END;

            SQL.Add(' SEQUENCIA=:SEQUENCIA');
            ParamByName('SEQUENCIA').Value := SEQUENCIA;

            SQL.Add(' WHERE SEQUENCIA=:SEQUENCIA');
            ParamByName('SEQUENCIA').Value := SEQUENCIA;

            ExecSQL;
        end;

        qry.Free;
        erro := '';
        result := true;

    except on ex:exception do
        begin
            erro := 'Erro ao alterar pessoa: ' + ex.Message;
            Result := false;
        end;
    end;
end;

end.
